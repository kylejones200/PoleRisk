{% extends "base.html" %}

{% block title %}Upload Data - Soil Moisture Analyzer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-upload"></i> Upload Data</h2>
        <p class="text-muted">Upload your soil moisture data files for analysis</p>
    </div>
</div>

<!-- Alert container -->
<div id="alert-container"></div>

<div class="row">
    <!-- Upload Form -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-cloud-upload-alt"></i> Upload File</h5>
            </div>
            <div class="card-body">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="data-file" class="form-label">Select Data File</label>
                        <input type="file" class="form-control" id="data-file" name="file" 
                               accept=".csv,.txt,.nc,.nc4" required>
                        <div class="form-text">
                            Supported formats: CSV, TXT (space-separated), NetCDF (.nc, .nc4)
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="progress" id="upload-progress" style="display: none;">
                            <div class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Upload File
                    </button>
                    <button type="button" class="btn btn-secondary ms-2" onclick="clearForm()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </form>
                
                <div id="upload-loading" class="loading">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Uploading and processing file...</p>
                </div>
            </div>
        </div>
        
        <!-- Upload Results -->
        <div class="card mt-4" id="upload-results" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-info-circle"></i> Upload Results</h5>
            </div>
            <div class="card-body">
                <div id="upload-stats"></div>
                
                <div class="mt-3">
                    <button class="btn btn-success" onclick="goToDashboard()">
                        <i class="fas fa-chart-line"></i> View in Dashboard
                    </button>
                    <button class="btn btn-info ms-2" onclick="downloadResults()">
                        <i class="fas fa-download"></i> Download Results
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar with Help -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-question-circle"></i> File Format Guide</h5>
            </div>
            <div class="card-body">
                <h6>CSV Format</h6>
                <p class="small">
                    Comma-separated values with headers. Expected columns:
                </p>
                <ul class="small">
                    <li><code>date</code> - Date in YYYY-MM-DD format</li>
                    <li><code>in_situ</code> - In-situ soil moisture values</li>
                    <li><code>satellite</code> - Satellite soil moisture values</li>
                </ul>
                
                <hr>
                
                <h6>TXT Format</h6>
                <p class="small">
                    Space-separated values, typically from match_results.txt:
                </p>
                <pre class="small bg-light p-2">20150401 0.0234 0.0567
20150402 0.0245 NaN
20150403 0.0221 0.0534</pre>
                
                <hr>
                
                <h6>NetCDF Format</h6>
                <p class="small">
                    AMSR2 LPRM NetCDF files with soil moisture variables.
                </p>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-lightbulb"></i> Tips</h5>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li>Maximum file size: 16MB</li>
                    <li>Missing values can be represented as NaN, NA, or empty</li>
                    <li>Date formats are auto-detected</li>
                    <li>Files are processed immediately after upload</li>
                    <li>Upload multiple files for comparative analysis</li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-list"></i> Uploaded Files</h5>
            </div>
            <div class="card-body">
                <div id="file-list-loading" class="loading">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Loading files...</span>
                </div>
                <div id="file-list"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let uploadedFileName = null;

document.addEventListener('DOMContentLoaded', function() {
    setupUploadForm();
    loadFileList();
});

function setupUploadForm() {
    const form = document.getElementById('upload-form');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('data-file');
        const file = fileInput.files[0];
        
        if (!file) {
            showAlert('Please select a file to upload', 'warning');
            return;
        }
        
        // Show loading and progress
        showLoading('upload-loading');
        document.getElementById('upload-progress').style.display = 'block';
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Upload failed');
            }
            
            uploadedFileName = result.filename;
            showUploadResults(result);
            showAlert('File uploaded successfully!', 'success');
            loadFileList(); // Refresh file list
            
        } catch (error) {
            console.error('Upload error:', error);
            showAlert(`Upload failed: ${error.message}`, 'danger');
        } finally {
            hideLoading('upload-loading');
            document.getElementById('upload-progress').style.display = 'none';
        }
    });
}

function showUploadResults(result) {
    const resultsDiv = document.getElementById('upload-results');
    const statsDiv = document.getElementById('upload-stats');
    
    let statsHtml = `
        <div class="row">
            <div class="col-md-6">
                <h6>File Information</h6>
                <ul class="list-unstyled">
                    <li><strong>Filename:</strong> ${result.filename}</li>
                    <li><strong>Rows:</strong> ${result.stats.n_rows}</li>
                    <li><strong>Columns:</strong> ${result.stats.columns.join(', ')}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Data Summary</h6>
    `;
    
    if (result.stats.date_range) {
        statsHtml += `
            <ul class="list-unstyled">
                <li><strong>Start Date:</strong> ${formatDate(result.stats.date_range.start)}</li>
                <li><strong>End Date:</strong> ${formatDate(result.stats.date_range.end)}</li>
            </ul>
        `;
    }
    
    statsHtml += '</div></div>';
    
    // Add column statistics
    if (result.stats.data_summary) {
        statsHtml += '<div class="mt-3"><h6>Column Statistics</h6><div class="row">';
        
        for (const [col, stats] of Object.entries(result.stats.data_summary)) {
            statsHtml += `
                <div class="col-md-6 mb-2">
                    <div class="card">
                        <div class="card-body py-2">
                            <h6 class="card-title mb-1">${col}</h6>
                            <div class="small">
                                Mean: ${formatNumber(stats.mean)}<br>
                                Range: ${formatNumber(stats.min)} - ${formatNumber(stats.max)}<br>
                                Missing: ${stats.missing_count}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        statsHtml += '</div></div>';
    }
    
    statsDiv.innerHTML = statsHtml;
    resultsDiv.style.display = 'block';
}

function clearForm() {
    document.getElementById('upload-form').reset();
    document.getElementById('upload-results').style.display = 'none';
    uploadedFileName = null;
}

function goToDashboard() {
    window.location.href = '/dashboard';
}

async function downloadResults() {
    if (!uploadedFileName) {
        showAlert('No file uploaded yet', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/visualize/${uploadedFileName}`);
        
        if (!response.ok) {
            throw new Error('Failed to generate results');
        }
        
        // Create download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'analysis_results.html';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showAlert('Analysis results downloaded!', 'success');
        
    } catch (error) {
        showAlert(`Failed to download results: ${error.message}`, 'danger');
    }
}

async function loadFileList() {
    const fileListDiv = document.getElementById('file-list');
    const loadingDiv = document.getElementById('file-list-loading');
    
    try {
        showLoading('file-list-loading');
        
        // This is a simplified version - in a real implementation,
        // you'd have an API endpoint to list uploaded files
        const status = await apiRequest('/status');
        
        let fileListHtml = '';
        
        if (status.system.data_files > 0) {
            fileListHtml = `
                <div class="small text-success">
                    <i class="fas fa-check-circle"></i> 
                    ${status.system.data_files} file(s) uploaded
                </div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="goToDashboard()">
                        View Files
                    </button>
                </div>
            `;
        } else {
            fileListHtml = `
                <div class="small text-muted">
                    <i class="fas fa-info-circle"></i> 
                    No files uploaded yet
                </div>
            `;
        }
        
        fileListDiv.innerHTML = fileListHtml;
        hideLoading('file-list-loading');
        
    } catch (error) {
        hideLoading('file-list-loading');
        fileListDiv.innerHTML = `
            <div class="small text-danger">
                <i class="fas fa-exclamation-triangle"></i> 
                Failed to load file list
            </div>
        `;
    }
}

// Drag and drop functionality
function setupDragDrop() {
    const uploadArea = document.querySelector('.card-body');
    
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('border-primary');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-primary');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-primary');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.getElementById('data-file').files = files;
        }
    });
}

// Initialize drag and drop
document.addEventListener('DOMContentLoaded', function() {
    setupDragDrop();
});
</script>
{% endblock %}
